{% extends 'customers/base.html' %}

{% block title %}Pay Invoice #{{ invoice.id }} - ADAKEV{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title text-center mb-0">Pay Invoice with M-Pesa</h4>
            </div>
            <div class="card-body">
                <!-- Invoice Summary -->
                <div class="alert alert-info">
                    <h6>Invoice Summary</h6>
                    <p class="mb-1"><strong>Invoice #:</strong> {{ invoice.id }}</p>
                    <p class="mb-1"><strong>Service:</strong> {{ invoice.customer_service.plan.name }}</p>
                    <p class="mb-1"><strong>Amount:</strong> KSh {{ invoice.amount }}</p>
                    <p class="mb-0"><strong>Due Date:</strong> {{ invoice.due_date|date:"M d, Y" }}</p>
                </div>

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="phone_number" class="form-label">M-Pesa Phone Number</label>
                        <input type="tel" class="form-control" id="phone_number" name="phone_number"
                               placeholder="254XXXXXXXXX" required pattern="254[0-9]{9}">
                        <div class="form-text">
                            Enter your M-Pesa registered phone number (e.g., 254712345678)
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> You will receive an M-Pesa prompt on your phone to complete the payment.
                        The payment will be processed automatically once confirmed.
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-mobile-alt"></i> Pay with M-Pesa STK Push
                        </button>
                        <a href="{% url 'customers:customer_invoice_detail' invoice.id %}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Payment Instructions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Payment Instructions</h6>
            </div>
            <div class="card-body">
                <ol>
                    <li>Enter your M-Pesa registered phone number</li>
                    <li>Click "Pay with M-Pesa STK Push"</li>
                    <li>You will receive a prompt on your phone</li>
                    <li>Enter your M-Pesa PIN to complete the payment</li>
                    <li>Payment confirmation will be sent via SMS</li>
                    <li>Your invoice will be marked as paid automatically</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Format phone number input
document.getElementById('phone_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.startsWith('0')) {
        value = '254' + value.substring(1);
    } else if (value.startsWith('254') === false && value.length >= 3) {
        value = '254' + value;
    }
    if (value.length > 12) {
        value = value.substring(0, 12);
    }
    e.target.value = value;
});
</script>
{% endblock %}
